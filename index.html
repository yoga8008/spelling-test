<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>å—é–€åœ‹å°æ‹¼å­—æŒ‘æˆ° Go</title>
<style>
  :root{
    --bg1:#eef6ff;
    --bg2:#f7fbff;
    --card:#ffffff;
    --ink:#0f172a;
    --muted:#64748b;
    --primary:#2563eb;
    --primary2:#1d4ed8;
    --good:#16a34a;
    --bad:#dc2626;
    --gold:#f59e0b;
    --shadow: 0 14px 40px rgba(2,6,23,.10);
    --shadow2: 0 8px 22px rgba(2,6,23,.10);
    --radius: 18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial, "Apple Color Emoji","Segoe UI Emoji";
    color:var(--ink);
    background:
      radial-gradient(1200px 600px at 10% 10%, #dbeafe 0%, transparent 55%),
      radial-gradient(900px 500px at 90% 20%, #e0e7ff 0%, transparent 50%),
      linear-gradient(180deg, var(--bg1), var(--bg2));
    overflow-x:hidden;
  }
  a{color:inherit}
  .topbar{
    position:sticky; top:0; z-index:20;
    backdrop-filter: blur(10px);
    background: rgba(255,255,255,.70);
    border-bottom: 1px solid rgba(148,163,184,.30);
  }
  .topbar-inner{
    max-width:1120px; margin:0 auto; padding:14px 14px;
    display:flex; gap:10px; align-items:center; justify-content:space-between;
  }
  .brand{
    display:flex; gap:10px; align-items:center;
    min-width: 260px;
  }
  .logo{
    width:42px;height:42px;border-radius:14px;
    background: linear-gradient(135deg,#22c55e,#16a34a);
    display:grid; place-items:center;
    box-shadow: var(--shadow2);
    color:#fff; font-size:22px; font-weight:900;
  }
  .brand h1{
    margin:0; font-size:18px; line-height:1.1;
    letter-spacing:.5px;
  }
  .brand small{
    display:block; margin-top:3px; color:var(--muted);
    font-size:12px;
  }
  .actions{
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    justify-content:flex-end;
  }
  .btn{
    border:0;
    border-radius: 14px;
    padding:10px 14px;
    background: #fff;
    box-shadow: var(--shadow2);
    cursor:pointer;
    font-weight:800;
    color:var(--ink);
    display:inline-flex; gap:8px; align-items:center;
    transition:.15s transform, .15s filter;
    user-select:none;
  }
  .btn:hover{transform: translateY(-1px); filter: brightness(1.02)}
  .btn:active{transform: translateY(0px); filter: brightness(.98)}
  .btn.primary{
    background: linear-gradient(180deg, var(--primary), var(--primary2));
    color:#fff;
  }
  .btn.ghost{
    background: rgba(255,255,255,.70);
    border: 1px solid rgba(148,163,184,.35);
    box-shadow:none;
  }
  .btn.danger{
    background: linear-gradient(180deg,#ef4444,#dc2626);
    color:#fff;
  }
  .wrap{
    max-width:1120px;
    margin: 18px auto 40px;
    padding: 0 14px;
  }
  .grid{
    display:grid;
    grid-template-columns: 420px 1fr;
    gap: 16px;
    align-items:start;
  }
  @media (max-width: 980px){
    .grid{grid-template-columns:1fr; }
    .brand{min-width:auto}
  }
  .card{
    background: rgba(255,255,255,.85);
    border: 1px solid rgba(148,163,184,.25);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }
  .panel{
    padding: 16px;
  }
  .panel h2{
    margin: 0 0 10px;
    font-size:16px;
    letter-spacing:.5px;
  }
  .row{
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
  }
  .label{
    font-weight:900;
    color: var(--muted);
    font-size:12px;
    letter-spacing:.5px;
  }
  .pill{
    display:inline-flex; gap:8px; align-items:center;
    padding:8px 10px;
    border-radius: 999px;
    background: rgba(226,232,240,.7);
    border: 1px solid rgba(148,163,184,.25);
    font-weight:800;
  }
  .input{
    width:100%;
    padding: 12px 14px;
    border-radius: 14px;
    border: 1px solid rgba(148,163,184,.35);
    outline:none;
    font-size: 15px;
    background: rgba(255,255,255,.95);
  }
  .input:focus{border-color: rgba(37,99,235,.6); box-shadow: 0 0 0 4px rgba(37,99,235,.15)}
  .help{
    margin:10px 0 0;
    color: var(--muted);
    font-size: 12px;
    line-height:1.45;
  }
  .kpi{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-top: 12px;
  }
  @media(max-width: 540px){
    .kpi{grid-template-columns:1fr}
  }
  .k{
    background: rgba(255,255,255,.9);
    border-radius: 16px;
    border: 1px solid rgba(148,163,184,.22);
    padding: 10px 12px;
  }
  .k b{display:block; font-size:18px}
  .k small{color:var(--muted); font-weight:800}
  .divider{
    height:1px; background: rgba(148,163,184,.25);
    margin: 14px 0;
  }

  /* badges */
  .badges{
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap:10px;
    margin-top: 10px;
  }
  @media(max-width: 540px){ .badges{grid-template-columns:repeat(2,1fr)} }
  .badge{
    border-radius: 18px;
    padding: 10px 10px;
    background: rgba(255,255,255,.9);
    border:1px solid rgba(148,163,184,.22);
    display:flex; gap:10px; align-items:center;
    min-height: 56px;
  }
  .badge .icon{
    width:40px;height:40px;border-radius:14px;
    display:grid; place-items:center;
    font-size:20px; font-weight:900; color:#fff;
    box-shadow: var(--shadow2);
  }
  .badge .t b{display:block; font-size:13px}
  .badge .t small{display:block; margin-top:2px; color:var(--muted); font-weight:900; font-size:11px}
  .icon.gold{background:linear-gradient(135deg,#f59e0b,#f97316)}
  .icon.blue{background:linear-gradient(135deg,#2563eb,#1d4ed8)}
  .icon.green{background:linear-gradient(135deg,#22c55e,#16a34a)}
  .icon.purple{background:linear-gradient(135deg,#a855f7,#7c3aed)}
  .icon.gray{background:linear-gradient(135deg,#94a3b8,#64748b)}

  /* map */
  .mapShell{ position:relative; overflow:hidden; }
  .mapHeader{
    display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    padding: 14px 16px 0;
  }
  .mapHeader h2{ margin:0; font-size:16px; }
  .mapNote{
    padding: 6px 16px 12px;
    color: var(--muted);
    font-weight:900;
    font-size: 12px;
  }
  .mapWrap{
    position:relative;
    padding: 10px 12px 16px;
    height: 620px;
  }
  @media(max-width:980px){ .mapWrap{height: 520px;} }
  .mapCanvas{
    position:absolute; inset: 10px 12px 16px;
    border-radius: 20px;
    background:
      radial-gradient(800px 400px at 20% 10%, rgba(34,197,94,.14), transparent 60%),
      radial-gradient(800px 500px at 80% 20%, rgba(245,158,11,.15), transparent 60%),
      linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.40));
    border:1px solid rgba(148,163,184,.25);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.7);
    overflow:auto;
    -webkit-overflow-scrolling:touch;
  }
  .mapInner{
    position:relative;
    min-width: 940px;
    min-height: 900px;
    padding: 18px;
  }
  .levelBtn{
    position:absolute;
    width: 84px;
    height: 84px;
    border-radius: 22px;
    border: 1px solid rgba(148,163,184,.25);
    background: rgba(255,255,255,.88);
    box-shadow: var(--shadow2);
    cursor:pointer;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    font-weight:900;
    transition: .12s transform, .12s filter;
    user-select:none;
  }
  .levelBtn:hover{transform:translateY(-1px); filter:brightness(1.03)}
  .levelBtn:active{transform:translateY(0px); filter:brightness(.99)}
  .levelBtn.locked{
    opacity:.45;
    cursor:not-allowed;
    filter: grayscale(.25);
  }
  .levelBtn .n{
    font-size:14px;
    margin-top:4px;
  }
  .levelBtn .mini{
    font-size:12px; color: var(--muted);
    font-weight:900;
  }
  .levelBtn .star{ font-size:16px; margin-bottom:2px; }
  .levelBtn.cleared{
    outline: 3px solid rgba(34,197,94,.25);
    box-shadow: 0 10px 22px rgba(34,197,94,.15), var(--shadow2);
  }
  .routeSvg{
    position:absolute;
    inset: 0;
    pointer-events:none;
  }

  /* game */
  .gameHeader{
    display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
  }
  .gameHeader .left{
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
  }
  .progressBar{
    height: 10px;
    border-radius: 999px;
    background: rgba(226,232,240,.9);
    border: 1px solid rgba(148,163,184,.25);
    overflow:hidden;
    width: 240px;
  }
  .progressBar > div{
    height: 100%;
    width:0%;
    background: linear-gradient(90deg,#22c55e,#16a34a);
  }
  .timer{
    font-weight:900;
    color: var(--bad);
    display:flex; gap:8px; align-items:center;
  }
  .modeTag{
    display:inline-flex; gap:8px; align-items:center;
    padding: 8px 10px;
    border-radius: 999px;
    background: rgba(37,99,235,.08);
    border: 1px solid rgba(37,99,235,.20);
    color:#1d4ed8;
    font-weight:1000;
  }
  .qTitle{
    margin: 14px 0 6px;
    font-size: 20px;
    font-weight: 1000;
    letter-spacing:.5px;
  }
  .qSub{
    margin: 0 0 14px;
    color: var(--muted);
    font-weight: 900;
  }
  .center{ text-align:center; }
  .wordBig{
    font-size: 54px;
    font-weight: 1100;
    letter-spacing: 1px;
    margin: 14px 0 14px;
  }
  .choices{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 10px;
  }
  @media(max-width:540px){ .choices{grid-template-columns:1fr} }
  .choice{
    padding: 14px 14px;
    border-radius: 16px;
    background: rgba(241,245,249,.95);
    border: 1px solid rgba(148,163,184,.25);
    font-weight: 1000;
    cursor:pointer;
    text-align:center;
    transition:.12s transform, .12s filter;
    user-select:none;
  }
  .choice:hover{transform: translateY(-1px); filter:brightness(1.02)}
  .choice:active{transform: translateY(0px); filter:brightness(.99)}
  .choice.good{background: rgba(34,197,94,.16); border-color: rgba(34,197,94,.35)}
  .choice.bad{background: rgba(220,38,38,.14); border-color: rgba(220,38,38,.35)}

  .hintBox{
    margin-top: 12px;
    padding: 12px 12px;
    border-radius: 16px;
    background: rgba(255,255,255,.90);
    border:1px dashed rgba(148,163,184,.55);
    color: var(--muted);
    font-weight:900;
  }

  /* listen controls */
  .listenRow{
    display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap;
    margin: 6px 0 6px;
  }
  .sliderWrap{
    display:flex; gap:10px; align-items:center;
    justify-content:center;
    margin-top: 8px;
    color: var(--muted);
    font-weight: 1000;
  }
  input[type="range"]{ width: 220px; }

  /* typing */
  .typeWrap{ display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin-top: 10px;}
  .typeInput{
    width: min(360px, 90vw);
    font-size: 22px;
    padding: 12px 14px;
    border-radius: 16px;
    border:1px solid rgba(148,163,184,.35);
    outline:none;
    text-align:center;
    background: rgba(255,255,255,.95);
    font-weight: 1100;
    letter-spacing: 1px;
  }
  .typeInput:focus{border-color: rgba(37,99,235,.6); box-shadow: 0 0 0 4px rgba(37,99,235,.15)}

  /* matching */
  .match-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    max-width: 720px;
    margin: 10px auto 0;
  }
  .match-col{ display:grid; gap: 12px; }
  .mcard{
    padding: 14px 12px;
    border-radius: 16px;
    background: rgba(241,245,249,.95);
    border: 1px solid rgba(148,163,184,.25);
    text-align:center;
    font-weight: 1100;
    cursor:pointer;
    user-select:none;
    transition:.12s transform, .12s filter;
  }
  .mcard:hover{transform:translateY(-1px); filter:brightness(1.02)}
  .mcard:active{transform:translateY(0px); filter:brightness(.99)}
  .mcard.active{ background: rgba(37,99,235,.14); border-color: rgba(37,99,235,.35) }
  .mcard.done{ background: rgba(34,197,94,.18); border-color: rgba(34,197,94,.35); pointer-events:none; opacity:.95 }

  /* footer buttons */
  .footRow{
    display:flex; gap:10px; justify-content:space-between; align-items:center; flex-wrap:wrap;
    margin-top: 14px;
  }
  .msg{
    font-weight:1000;
    padding: 10px 12px;
    border-radius: 16px;
    background: rgba(255,255,255,.9);
    border: 1px solid rgba(148,163,184,.25);
  }
  .msg.good{ color: var(--good); }
  .msg.bad{ color: var(--bad); }
  .small{ font-size:12px; color: var(--muted); font-weight:900; }

  /* modal */
  .modalBack{
    position:fixed; inset:0; z-index:50;
    background: rgba(2,6,23,.45);
    display:none;
    align-items:center; justify-content:center;
    padding: 18px;
  }
  .modal{
    width: min(920px, 96vw);
    border-radius: 22px;
    background: rgba(255,255,255,.95);
    border: 1px solid rgba(148,163,184,.30);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .modalHead{
    padding: 14px 16px;
    display:flex; justify-content:space-between; align-items:center; gap:10px;
    background: linear-gradient(180deg, rgba(226,232,240,.8), rgba(255,255,255,.85));
    border-bottom: 1px solid rgba(148,163,184,.25);
  }
  .modalHead h3{ margin:0; font-size:16px; letter-spacing:.5px }
  .modalBody{ padding: 14px 16px 16px; }
  .typePick{
    display:flex; gap:8px; flex-wrap:wrap;
    margin-top: 8px;
  }
  .chip{
    padding: 10px 12px;
    border-radius: 999px;
    background: rgba(226,232,240,.75);
    border: 1px solid rgba(148,163,184,.25);
    font-weight:1100;
    cursor:pointer;
    user-select:none;
  }
  .chip.on{ background: rgba(34,197,94,.20); border-color: rgba(34,197,94,.40); }
  .chip.all{ background: rgba(37,99,235,.14); border-color: rgba(37,99,235,.30); }
  .modalFoot{
    padding: 12px 16px 16px;
    display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;
    border-top: 1px solid rgba(148,163,184,.25);
  }

  /* confetti */
  #confetti{
    position:fixed; inset:0; pointer-events:none; z-index:60;
    overflow:hidden; display:none;
  }
  .confettiPiece{
    position:absolute;
    width: 10px; height: 16px;
    border-radius: 2px;
    opacity:.95;
    animation: fall 1200ms linear forwards;
  }
  @keyframes fall{
    0%{ transform: translateY(-20px) rotate(0deg); }
    100%{ transform: translateY(110vh) rotate(680deg); }
  }

  /* streak pop */
  .pop{
    position:fixed; left:50%; top:16%;
    transform: translateX(-50%);
    z-index:70;
    background: rgba(255,255,255,.95);
    border: 1px solid rgba(148,163,184,.30);
    box-shadow: var(--shadow);
    border-radius: 20px;
    padding: 12px 14px;
    display:none;
    font-weight:1100;
  }

  /* fullscreen hint */
  .fsTip{
    display:none;
    margin-left: 6px;
    color: var(--muted);
    font-weight: 900;
    font-size: 12px;
  }
  @media (max-width: 980px){
    .fsTip{display:inline}
  }
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <div class="logo">Go</div>
      <div>
        <h1>å—é–€åœ‹å°æ‹¼å­—æŒ‘æˆ° Go</h1>
        <small>100 é—œï½œæ¯é—œ 10 é¡Œï½œéé—œé–€æª»ï¼šç­”å° 8 é¡Œï¼ˆå«ï¼‰ï½œA/B/C/D æˆ–å…¨é¸</small>
      </div>
    </div>
    <div class="actions">
      <button class="btn ghost" id="btnFullscreen">ğŸ–¥ï¸ å…¨è¢å¹•<span class="fsTip">ï¼ˆå¹³æ¿å»ºè­°ï¼‰</span></button>
      <button class="btn ghost" id="btnOpenTypeModal">ğŸ§© é¡Œå‹é¸æ“‡</button>
      <button class="btn ghost" id="btnResetStudent">ğŸ§¹ æ¸…é™¤æœ¬æ©Ÿè³‡æ–™</button>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="grid">
    <!-- left -->
    <div class="card panel">
      <h2>ğŸ‘¤ å­¸ç”Ÿç™»å…¥ï¼ˆä¸ç”¨å¯†ç¢¼ï¼‰</h2>
      <div class="row" style="justify-content:space-between">
        <div class="pill">ç›®å‰ï¼š<span id="curStudent">ï¼ˆå°šæœªç™»å…¥ï¼‰</span></div>
        <div class="pill">å·²é€šé—œï¼š<span id="curCleared">0</span>/100</div>
      </div>
      <div style="margin-top:10px">
        <div class="label">è¼¸å…¥å­¸ç”Ÿå§“åï¼ˆä¸å¯ç©ºç™½ï¼‰</div>
        <div class="row" style="margin-top:6px">
          <input class="input" id="studentName" placeholder="ä¾‹ï¼šå°æ˜ / è¨±Yoga" />
          <button class="btn primary" id="btnLogin">ç™»å…¥</button>
        </div>
        <div class="help">
          âœ… åŒä¸€å°æ‰‹æ©Ÿ/å¹³æ¿æœƒè¨˜ä½å¤šä½å­¸ç”Ÿã€‚<br/>
          âš ï¸ ä¸åŒæ‰‹æ©Ÿç™»å…¥åŒå/ä¸åŒåï¼šè³‡æ–™åªåœ¨è©²è£ç½®ï¼ˆlocalStorageï¼‰ã€‚å¦‚æœä½ è¦è·¨è£ç½®åŒæ­¥ï¼Œéœ€è¦ä¼ºæœå™¨ï¼Œç´” GitHub Pages åšä¸åˆ°ã€‚
        </div>
      </div>

      <div class="divider"></div>

      <h2>ğŸ… å¾½ç« ï¼ˆé¦–é é¡¯ç¤ºï¼‰</h2>
      <div class="badges" id="badgeBox"></div>
      <div class="help">
        å¾½ç« æœƒä¾å­¸ç”Ÿå€‹äººè¨˜éŒ„è§£é–ï¼šä¾‹å¦‚ã€Œé¦–æ¬¡é€šé—œã€ã€ã€Œé€£çºŒç­”å° 5 é¡Œ / 10 é¡Œã€ã€ã€Œå–®é—œæ»¿åˆ†ã€ã€ã€Œé€šé—œæ•¸ã€ç­‰ã€‚
      </div>

      <div class="divider"></div>

      <h2>âš™ï¸ é¡Œå‹è¨­å®šï¼ˆæœƒå½±éŸ¿æ¯é—œé¡Œç›®ï¼‰</h2>
      <div class="row">
        <span class="pill">ç›®å‰é¡Œå‹ï¼š<b id="typeSummary">å…¨é¸ A/B/C/D</b></span>
        <span class="pill">é…å°é¡Œï¼šæ¯é¡Œ 4 çµ„</span>
      </div>
      <div class="help">
        è‹¥é¸ã€Œå…¨é¸ã€ï¼Œæ¯é—œ 10 é¡Œæœƒè‡ªå‹•æ··åˆ A/B/C/Dï¼ˆå¹³å‡åˆ†é…ï¼Œä¸¦éš¨æ©Ÿæ’åºï¼‰ã€‚<br/>
        è‹¥åªå‹¾ A/C/Dï¼Œå‰‡æ¯é—œ 10 é¡Œåªæœƒå¾ä½ å‹¾é¸çš„é¡Œå‹å‡ºé¡Œã€‚
      </div>

      <div class="divider"></div>

      <h2>â–¶ï¸ é–‹å§‹</h2>
      <div class="row">
        <button class="btn primary" id="btnStartNext">ğŸš€ é–‹å§‹ä¸‹ä¸€é—œ</button>
        <button class="btn ghost" id="btnGoMap">ğŸ—ºï¸ åœ°åœ–</button>
      </div>
      <div class="kpi">
        <div class="k"><b id="kLevel">â€”</b><small>ä¸‹ä¸€é—œ</small></div>
        <div class="k"><b id="kNeed">8/10</b><small>éé—œé–€æª»</small></div>
        <div class="k"><b id="kBest">â€”</b><small>æœ¬é—œæœ€é«˜åˆ†</small></div>
      </div>
    </div>

    <!-- right -->
    <div class="card mapShell">
      <div class="mapHeader">
        <h2>ğŸ—ºï¸ å¯¶è—åœ°åœ–ï¼ˆ100 é—œï¼‰</h2>
        <div class="row">
          <span class="pill">â­ éé—œï¼šç­”å° 8 é¡Œï¼ˆå«ï¼‰</span>
          <span class="pill">ğŸ” å¯é‡ç©ï¼šé‡ç©ä¸å½±éŸ¿è§£é–</span>
        </div>
      </div>
      <div class="mapNote">æç¤ºï¼šæœªé” 8 åˆ†çš„é—œå¡ï¼Œä¸‹ä¸€é—œæœƒè‡ªå‹•é–ä½ã€Œä¸èƒ½é»ã€ã€‚</div>

      <div class="mapWrap">
        <div class="mapCanvas" id="mapCanvas">
          <div class="mapInner" id="mapInner">
            <svg class="routeSvg" id="routeSvg"></svg>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Game Modal -->
<div class="modalBack" id="gameBack">
  <div class="modal">
    <div class="modalHead">
      <h3 id="gameTitle">ç¬¬ X é—œ</h3>
      <button class="btn ghost" id="btnCloseGame">âœ– é—œé–‰</button>
    </div>
    <div class="modalBody">
      <div class="gameHeader">
        <div class="left">
          <span class="pill">é¡Œç›®ï¼š<b id="qIdx">1</b>/10</span>
          <span class="pill">å¾—åˆ†ï¼š<b id="score">0</b>/10</span>
          <span class="pill">ç›®æ¨™ï¼š<b>â‰¥8</b> æ‰èƒ½è§£é–ä¸‹ä¸€é—œ</span>
          <span class="modeTag" id="modeTag">A</span>
        </div>
        <div class="row">
          <div class="timer">â±ï¸ <span id="time">00:00</span></div>
          <div class="progressBar"><div id="bar"></div></div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Listen controls (always shown but may be used by A/D) -->
      <div class="listenRow">
        <button class="btn primary" id="btnPlay">ğŸ”Š æ’­æ”¾</button>
        <button class="btn ghost" id="btnReplay">ğŸ” é‡æ’­</button>
      </div>
      <div class="sliderWrap">
        ğŸ¢ æ…¢
        <input type="range" min="0.6" max="1.2" step="0.05" id="rate" />
        ğŸ‡ å¿«
        <span class="pill">é€Ÿåº¦ï¼š<b id="rateVal">0.90</b></span>
      </div>

      <div class="center">
        <div class="qTitle" id="qTitle">é¡Œç›®</div>
        <div class="qSub" id="qSub">èªªæ˜</div>
      </div>

      <div id="questionArea"></div>

      <div class="footRow">
        <button class="btn ghost" id="btnPrev">â¬…ï¸ ä¸Šä¸€é¡Œ</button>
        <div class="row" style="gap:8px">
          <button class="btn ghost" id="btnBackToMap">ğŸ—ºï¸ å›é—œå¡</button>
          <button class="btn primary" id="btnNext">â¡ï¸ ä¸‹ä¸€é¡Œ</button>
        </div>
      </div>
      <div id="feedback" style="margin-top:12px"></div>
      <div class="small" style="margin-top:8px">
        â€» A é¡Œå‹ã€Œè½åŠ›é¸å­—ã€ï¼šä¸æœƒé¡¯ç¤ºè‹±æ–‡å–®å­—ï¼Œä¹Ÿä¸æœƒå¿µé¡Œè™Ÿï¼Œåªå¿µå–®å­—æœ¬èº«ã€‚<br/>
        â€» D é¡Œå‹ã€Œè½åŠ›æ‹¼éŸ³ã€ï¼šä¸é¡¯ç¤ºè‹±æ–‡ï¼Œè«‹è¼¸å…¥ä½ è½åˆ°çš„æ‹¼å­—ï¼ˆå¤§å°å¯«ä¸æ‹˜ï¼‰ã€‚éŒ¯äº†æœƒé¡¯ç¤ºæ­£è§£ã€‚
      </div>
    </div>
  </div>
</div>

<!-- Type Modal -->
<div class="modalBack" id="typeBack">
  <div class="modal">
    <div class="modalHead">
      <h3>ğŸ§© é¡Œå‹é¸æ“‡ï¼ˆå½±éŸ¿æ¯é—œå‡ºé¡Œï¼‰</h3>
      <button class="btn ghost" id="btnCloseType">âœ– é—œé–‰</button>
    </div>
    <div class="modalBody">
      <div class="pill all" style="margin-bottom:10px">é¸ã€Œå…¨é¸ã€ï¼šæ¯é—œ 10 é¡Œæœƒæ··åˆ A/B/C/Dï¼ˆå¹³å‡åˆ†é…ï¼‹éš¨æ©Ÿæ’åºï¼‰</div>
      <div class="typePick">
        <div class="chip all" id="chipAll">âœ… å…¨é¸ A/B/C/D</div>
        <div class="chip" id="chipA">Aï¼šè½åŠ›é¸å­—ï¼ˆè½â†’é¸ä¸­æ–‡ï½œä¸é¡¯ç¤ºè‹±æ–‡ï¼‰</div>
        <div class="chip" id="chipB">Bï¼šçœ‹è‹±é¸å­—ï¼ˆçœ‹è‹±æ–‡â†’é¸ä¸­æ–‡ï¼‰</div>
        <div class="chip" id="chipC">Cï¼šä¸­è‹±é…å°ï¼ˆæ¯é¡Œ 4 çµ„ï¼‰</div>
        <div class="chip" id="chipD">Dï¼šè½åŠ›æ‹¼éŸ³ï¼ˆè½â†’æ‹¼è‹±æ–‡ï½œä¸é¡¯ç¤ºè‹±æ–‡ï¼‰</div>
      </div>
      <div class="help" style="margin-top:10px">
        ä½ å¯åªå‹¾ A/C/Dï¼ˆæˆ–ä»»æ„çµ„åˆï¼‰ã€‚è‡³å°‘è¦é¸ 1 ç¨®é¡Œå‹ã€‚<br/>
        é…å°é¡Œï¼ˆCï¼‰ï¼šæ¯ä¸€é¡Œå›ºå®š 4 çµ„é…å°ï¼Œé»è‹±æ–‡å†é»ä¸­æ–‡ï¼›é»éŒ¯æœƒç›´æ¥å‘Šè¨´ä½ ã€Œæ­£ç¢ºç­”æ¡ˆã€ã€‚
      </div>
    </div>
    <div class="modalFoot">
      <button class="btn primary" id="btnSaveType">å„²å­˜è¨­å®š</button>
    </div>
  </div>
</div>

<div id="confetti"></div>
<div class="pop" id="pop"></div>

<script>
/* ==============================
   0) é¡Œåº«ï¼ˆ153 é¡Œï½œä¸è¦çœç•¥ï¼‰
   æ ¼å¼ï¼š{en:"", zh:""}
================================ */
const WORDS = [
  {en:"able", zh:"èƒ½å¤ çš„"}, {en:"about", zh:"é—œæ–¼"}, {en:"above", zh:"åœ¨ä¸Šé¢"},
  {en:"across", zh:"ç©¿éï¼›åœ¨å°é¢"}, {en:"act", zh:"è¡Œå‹•ï¼›è¡¨æ¼”"}, {en:"add", zh:"åŠ "},
  {en:"afraid", zh:"å®³æ€•çš„"}, {en:"after", zh:"åœ¨â€¦ä¹‹å¾Œ"}, {en:"again", zh:"å†ä¸€æ¬¡"},
  {en:"air", zh:"ç©ºæ°£"}, {en:"all", zh:"å…¨éƒ¨"}, {en:"always", zh:"ç¸½æ˜¯"},
  {en:"animal", zh:"å‹•ç‰©"}, {en:"answer", zh:"ç­”æ¡ˆï¼›å›ç­”"}, {en:"apple", zh:"è˜‹æœ"},
  {en:"arm", zh:"æ‰‹è‡‚"}, {en:"around", zh:"åœ¨å‘¨åœ"}, {en:"ask", zh:"å•"},
  {en:"away", zh:"é›¢é–‹"}, {en:"baby", zh:"å¯¶å¯¶"}, {en:"back", zh:"å¾Œé¢ï¼›å›ä¾†"},
  {en:"ball", zh:"çƒ"}, {en:"banana", zh:"é¦™è•‰"}, {en:"basket", zh:"ç±ƒå­"},
  {en:"bath", zh:"æ´—æ¾¡"}, {en:"beach", zh:"æµ·ç˜"}, {en:"bear", zh:"ç†Š"},
  {en:"because", zh:"å› ç‚º"}, {en:"bed", zh:"åºŠ"}, {en:"bee", zh:"èœœèœ‚"},
  {en:"before", zh:"åœ¨â€¦ä¹‹å‰"}, {en:"begin", zh:"é–‹å§‹"}, {en:"behind", zh:"åœ¨å¾Œé¢"},
  {en:"best", zh:"æœ€å¥½"}, {en:"big", zh:"å¤§çš„"}, {en:"bird", zh:"é³¥"},
  {en:"birthday", zh:"ç”Ÿæ—¥"}, {en:"black", zh:"é»‘è‰²"}, {en:"blue", zh:"è—è‰²"},
  {en:"boat", zh:"èˆ¹"}, {en:"book", zh:"æ›¸"}, {en:"box", zh:"ç›’å­"},
  {en:"boy", zh:"ç”·å­©"}, {en:"bread", zh:"éºµåŒ…"}, {en:"breakfast", zh:"æ—©é¤"},
  {en:"bring", zh:"å¸¶ä¾†"}, {en:"brother", zh:"å…„å¼Ÿ"}, {en:"brown", zh:"æ£•è‰²"},
  {en:"bus", zh:"å…¬è»Š"}, {en:"busy", zh:"å¿™ç¢Œçš„"}, {en:"but", zh:"ä½†æ˜¯"},
  {en:"buy", zh:"è²·"}, {en:"cake", zh:"è›‹ç³•"}, {en:"call", zh:"æ‰“é›»è©±ï¼›å‘¼å«"},
  {en:"can", zh:"å¯ä»¥"}, {en:"cap", zh:"å¸½å­"}, {en:"car", zh:"æ±½è»Š"},
  {en:"careful", zh:"å°å¿ƒçš„"}, {en:"carry", zh:"æ¬ï¼›æ‹¿"}, {en:"cat", zh:"è²“"},
  {en:"chair", zh:"æ¤…å­"}, {en:"chicken", zh:"é›ï¼›é›è‚‰"}, {en:"children", zh:"å­©å­å€‘"},
  {en:"clean", zh:"ä¹¾æ·¨çš„ï¼›æ‰“æƒ"}, {en:"clock", zh:"æ™‚é˜"}, {en:"close", zh:"é—œï¼›é è¿‘"},
  {en:"cloud", zh:"é›²"}, {en:"cold", zh:"å†·çš„"}, {en:"color", zh:"é¡è‰²"},
  {en:"come", zh:"ä¾†"}, {en:"cook", zh:"ç…®"}, {en:"cookie", zh:"é¤…ä¹¾"},
  {en:"cool", zh:"æ¶¼çˆ½çš„ï¼›å¾ˆé…·"}, {en:"corn", zh:"ç‰ç±³"}, {en:"cow", zh:"ç‰›"},
  {en:"cry", zh:"å“­"}, {en:"cup", zh:"æ¯å­"}, {en:"cute", zh:"å¯æ„›çš„"},
  {en:"dance", zh:"è·³èˆ"}, {en:"day", zh:"å¤©ï¼›ç™½å¤©"}, {en:"dear", zh:"è¦ªæ„›çš„"},
  {en:"desk", zh:"æ›¸æ¡Œ"}, {en:"dinner", zh:"æ™šé¤"}, {en:"do", zh:"åš"},
  {en:"dog", zh:"ç‹—"}, {en:"door", zh:"é–€"}, {en:"down", zh:"å‘ä¸‹ï¼›ä¸‹é¢"},
  {en:"draw", zh:"ç•«"}, {en:"dream", zh:"å¤¢"}, {en:"drink", zh:"å–"},
  {en:"drive", zh:"é–‹è»Š"}, {en:"duck", zh:"é´¨å­"}, {en:"ear", zh:"è€³æœµ"},
  {en:"eat", zh:"åƒ"}, {en:"egg", zh:"è›‹"}, {en:"eight", zh:"å…«"},
  {en:"end", zh:"çµæŸ"}, {en:"enjoy", zh:"äº«å—ï¼›å–œæ­¡"}, {en:"evening", zh:"æ™šä¸Š"},
  {en:"every", zh:"æ¯ä¸€å€‹"}, {en:"eye", zh:"çœ¼ç›"}, {en:"face", zh:"è‡‰"},
  {en:"family", zh:"å®¶äºº"}, {en:"far", zh:"é çš„"}, {en:"farm", zh:"è¾²å ´"},
  {en:"fast", zh:"å¿«çš„"}, {en:"father", zh:"çˆ¸çˆ¸"}, {en:"feel", zh:"æ„Ÿè¦º"},
  {en:"find", zh:"æ‰¾åˆ°"}, {en:"fish", zh:"é­š"}, {en:"five", zh:"äº”"},
  {en:"flower", zh:"èŠ±"}, {en:"fly", zh:"é£›ï¼›è’¼è …"}, {en:"food", zh:"é£Ÿç‰©"},
  {en:"four", zh:"å››"}, {en:"friend", zh:"æœ‹å‹"}, {en:"from", zh:"å¾"},
  {en:"fruit", zh:"æ°´æœ"}, {en:"fun", zh:"æœ‰è¶£"}, {en:"game", zh:"éŠæˆ²"},
  {en:"garden", zh:"èŠ±åœ’"}, {en:"get", zh:"å¾—åˆ°ï¼›å»æ‹¿"}, {en:"girl", zh:"å¥³å­©"},
  {en:"give", zh:"çµ¦"}, {en:"go", zh:"å»"}, {en:"good", zh:"å¥½çš„"},
  {en:"green", zh:"ç¶ è‰²"}, {en:"hair", zh:"é ­é«®"}, {en:"hand", zh:"æ‰‹"},
  {en:"happy", zh:"é–‹å¿ƒçš„"}, {en:"hat", zh:"å¸½å­"}, {en:"have", zh:"æœ‰"},
  {en:"he", zh:"ä»–"}, {en:"hear", zh:"è½è¦‹"}, {en:"help", zh:"å¹«å¿™"},
  {en:"here", zh:"é€™è£¡"}, {en:"home", zh:"å®¶"}, {en:"hot", zh:"ç†±çš„"},
  {en:"house", zh:"æˆ¿å­"}, {en:"how", zh:"å¦‚ä½•"}, {en:"hungry", zh:"è‚šå­é¤“"},
  {en:"ice", zh:"å†°"}, {en:"in", zh:"åœ¨è£¡é¢"}, {en:"jump", zh:"è·³"},
  {en:"kid", zh:"å°å­©"}, {en:"king", zh:"åœ‹ç‹"}, {en:"kitchen", zh:"å»šæˆ¿"},
  {en:"lake", zh:"æ¹–"}, {en:"lamp", zh:"ç‡ˆ"}, {en:"laugh", zh:"ç¬‘"},
  {en:"leaf", zh:"è‘‰å­"}, {en:"learn", zh:"å­¸ç¿’"}, {en:"left", zh:"å·¦é‚Š"},
  {en:"leg", zh:"è…¿"}, {en:"like", zh:"å–œæ­¡"}, {en:"lion", zh:"ç…å­"},
  {en:"listen", zh:"è½"}, {en:"little", zh:"å°çš„"}, {en:"live", zh:"ä½ï¼›æ´»è‘—"},
  {en:"long", zh:"é•·çš„"}, {en:"look", zh:"çœ‹"}, {en:"love", zh:"æ„›"},
  {en:"lunch", zh:"åˆé¤"}, {en:"make", zh:"åšï¼›è£½ä½œ"}, {en:"man", zh:"ç”·äºº"},
  {en:"many", zh:"è¨±å¤š"}, {en:"meet", zh:"é‡è¦‹"}, {en:"milk", zh:"ç‰›å¥¶"},
  {en:"mom", zh:"åª½åª½"}, {en:"money", zh:"éŒ¢"}, {en:"moon", zh:"æœˆäº®"},
  {en:"morning", zh:"æ—©ä¸Š"}, {en:"mother", zh:"åª½åª½"}, {en:"mouse", zh:"è€é¼ "},
  {en:"music", zh:"éŸ³æ¨‚"}, {en:"name", zh:"åå­—"}, {en:"near", zh:"é è¿‘"},
  {en:"need", zh:"éœ€è¦"}, {en:"new", zh:"æ–°çš„"}, {en:"night", zh:"å¤œæ™š"},
  {en:"nine", zh:"ä¹"}, {en:"no", zh:"ä¸"}, {en:"nose", zh:"é¼»å­"},
  {en:"now", zh:"ç¾åœ¨"}, {en:"number", zh:"æ•¸å­—"}, {en:"ocean", zh:"æµ·æ´‹"},
  {en:"of", zh:"çš„"}, {en:"off", zh:"é—œæ‰ï¼›é›¢é–‹"}, {en:"on", zh:"åœ¨ä¸Šé¢"},
  {en:"one", zh:"ä¸€"}, {en:"open", zh:"æ‰“é–‹"}, {en:"orange", zh:"æ©˜å­"},
  {en:"outside", zh:"å¤–é¢"}, {en:"over", zh:"åœ¨ä¸Šæ–¹ï¼›çµæŸ"}, {en:"page", zh:"é "},
  {en:"paint", zh:"ç•«ï¼›æ²¹æ¼†"}, {en:"paper", zh:"ç´™"}, {en:"park", zh:"å…¬åœ’"},
  {en:"party", zh:"æ´¾å°"}, {en:"pen", zh:"ç­†"}, {en:"pencil", zh:"é‰›ç­†"},
  {en:"people", zh:"äººå€‘"}, {en:"pet", zh:"å¯µç‰©"}, {en:"phone", zh:"é›»è©±"},
  {en:"pig", zh:"è±¬"}, {en:"pink", zh:"ç²‰ç´…è‰²"}, {en:"play", zh:"ç©"},
  {en:"please", zh:"è«‹"}, {en:"pool", zh:"æ¸¸æ³³æ± "}, {en:"purple", zh:"ç´«è‰²"},
  {en:"rain", zh:"é›¨"}, {en:"read", zh:"è®€"}, {en:"red", zh:"ç´…è‰²"},
  {en:"right", zh:"å³é‚Šï¼›æ­£ç¢º"}, {en:"river", zh:"æ²³"}, {en:"run", zh:"è·‘"},
  {en:"sad", zh:"é›£éçš„"}, {en:"safe", zh:"å®‰å…¨çš„"}, {en:"say", zh:"èªª"},
  {en:"school", zh:"å­¸æ ¡"}, {en:"sea", zh:"æµ·"}, {en:"see", zh:"çœ‹è¦‹"},
  {en:"seven", zh:"ä¸ƒ"}, {en:"she", zh:"å¥¹"}, {en:"ship", zh:"èˆ¹"},
  {en:"shirt", zh:"è¥¯è¡«"}, {en:"shoe", zh:"é‹å­"}, {en:"shop", zh:"å•†åº—"},
  {en:"short", zh:"çŸ­çš„"}, {en:"show", zh:"å±•ç¤º"}, {en:"sing", zh:"å”±æ­Œ"},
  {en:"sister", zh:"å§Šå¦¹"}, {en:"sit", zh:"å"}, {en:"six", zh:"å…­"},
  {en:"sleep", zh:"ç¡è¦º"}, {en:"small", zh:"å°çš„"}, {en:"smart", zh:"è°æ˜çš„"},
  {en:"snow", zh:"é›ª"}, {en:"so", zh:"æ‰€ä»¥"}, {en:"some", zh:"ä¸€äº›"},
  {en:"song", zh:"æ­Œæ›²"}, {en:"sorry", zh:"å°ä¸èµ·"}, {en:"spell", zh:"æ‹¼å­—"},
  {en:"star", zh:"æ˜Ÿæ˜Ÿ"}, {en:"start", zh:"é–‹å§‹"}, {en:"stay", zh:"åœç•™"},
  {en:"stop", zh:"åœæ­¢"}, {en:"store", zh:"å•†åº—"}, {en:"sun", zh:"å¤ªé™½"},
  {en:"sweet", zh:"ç”œçš„"}, {en:"table", zh:"æ¡Œå­"}, {en:"take", zh:"æ‹¿"},
  {en:"talk", zh:"èªªè©±"}, {en:"teacher", zh:"è€å¸«"}, {en:"ten", zh:"å"},
  {en:"thank", zh:"æ„Ÿè¬"}, {en:"that", zh:"é‚£å€‹"}, {en:"the", zh:"é€™å€‹(å† è©)"},
  {en:"there", zh:"é‚£è£¡"}, {en:"they", zh:"ä»–å€‘"}, {en:"three", zh:"ä¸‰"},
  {en:"time", zh:"æ™‚é–“"}, {en:"tired", zh:"ç´¯çš„"}, {en:"to", zh:"åˆ°ï¼›å‘"},
  {en:"today", zh:"ä»Šå¤©"}, {en:"tomorrow", zh:"æ˜å¤©"}, {en:"toy", zh:"ç©å…·"},
  {en:"train", zh:"ç«è»Šï¼›è¨“ç·´"}, {en:"tree", zh:"æ¨¹"}, {en:"two", zh:"äºŒ"},
  {en:"up", zh:"å‘ä¸Š"}, {en:"use", zh:"ä½¿ç”¨"}, {en:"very", zh:"éå¸¸"},
  {en:"walk", zh:"èµ°è·¯"}, {en:"want", zh:"æƒ³è¦"}, {en:"warm", zh:"æº«æš–çš„"},
  {en:"water", zh:"æ°´"}, {en:"we", zh:"æˆ‘å€‘"}, {en:"weather", zh:"å¤©æ°£"},
  {en:"welcome", zh:"æ­¡è¿"}, {en:"what", zh:"ä»€éº¼"}, {en:"when", zh:"ä½•æ™‚"},
  {en:"where", zh:"å“ªè£¡"}, {en:"white", zh:"ç™½è‰²"}, {en:"who", zh:"èª°"},
  {en:"why", zh:"ç‚ºä»€éº¼"}, {en:"win", zh:"è´"}, {en:"window", zh:"çª—æˆ¶"},
  {en:"with", zh:"å’Œï¼›è·Ÿ"}, {en:"woman", zh:"å¥³äºº"}, {en:"work", zh:"å·¥ä½œ"},
  {en:"write", zh:"å¯«"}, {en:"yellow", zh:"é»ƒè‰²"}, {en:"yes", zh:"æ˜¯"},
  {en:"you", zh:"ä½ "}, {en:"your", zh:"ä½ çš„"}
];
// ç¢ºä¿æ­£å¥½ 153 é¡Œï¼ˆä½ è¦å®Œæ•´é¡Œåº«ï¼‰ï¼š
if (WORDS.length !== 153) console.warn("é¡Œåº«ä¸æ˜¯ 153ï¼Œå¯¦éš›ï¼š", WORDS.length);

/* ==============================
   1) Storage / Student
================================ */
const LS_KEY = "nmps_spelling_go_vFinal";
function loadAll(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY)||"{}"); }catch{ return {}; }
}
function saveAll(obj){
  localStorage.setItem(LS_KEY, JSON.stringify(obj));
}
function ensureStudent(all, name){
  if(!all.students) all.students = {};
  if(!all.students[name]){
    all.students[name]={
      name,
      cleared: {},     // level -> {bestScore, passed, attempts, firstClearTs}
      badges: {},      // badgeId -> true
      totalPassed:0,
      lastPlayed: null
    };
  }
  if(!all.settings) all.settings = {};
  if(!all.settings.typeMode) all.settings.typeMode = { all:true, A:true,B:true,C:true,D:true };
  if(!all.settings.speechRate) all.settings.speechRate = 0.90;
  return all.students[name];
}

let ALL = loadAll();
let currentStudent = null;
let currentName = "";
let typeMode = (ALL.settings && ALL.settings.typeMode) || { all:true, A:true,B:true,C:true,D:true };
let speechRate = (ALL.settings && ALL.settings.speechRate) || 0.90;

/* ==============================
   2) UI refs
================================ */
const el = id=>document.getElementById(id);
const curStudentEl = el("curStudent");
const curClearedEl = el("curCleared");
const kLevelEl = el("kLevel");
const kBestEl = el("kBest");
const typeSummaryEl = el("typeSummary");
const badgeBox = el("badgeBox");

const mapInner = el("mapInner");
const routeSvg = el("routeSvg");

const gameBack = el("gameBack");
const gameTitle = el("gameTitle");
const qIdxEl = el("qIdx");
const scoreEl = el("score");
const modeTagEl = el("modeTag");
const timeEl = el("time");
const barEl = el("bar");
const qTitleEl = el("qTitle");
const qSubEl = el("qSub");
const questionArea = el("questionArea");
const feedback = el("feedback");

const rateSlider = el("rate");
const rateVal = el("rateVal");

/* ==============================
   3) Fullscreen
================================ */
el("btnFullscreen").onclick = async()=>{
  try{
    if(!document.fullscreenElement) await document.documentElement.requestFullscreen();
    else await document.exitFullscreen();
  }catch(e){
    alert("âš ï¸ ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´å…¨è¢å¹•æˆ–è¢«é™åˆ¶ã€‚");
  }
};

/* ==============================
   4) Type modal (A/B/C/D / all)
================================ */
const typeBack = el("typeBack");
const chipAll = el("chipAll");
const chipA = el("chipA");
const chipB = el("chipB");
const chipC = el("chipC");
const chipD = el("chipD");

function refreshTypeChips(){
  chipAll.classList.toggle("on", !!typeMode.all);
  chipAll.classList.toggle("all", true);
  chipA.classList.toggle("on", !!typeMode.A && !typeMode.all);
  chipB.classList.toggle("on", !!typeMode.B && !typeMode.all);
  chipC.classList.toggle("on", !!typeMode.C && !typeMode.all);
  chipD.classList.toggle("on", !!typeMode.D && !typeMode.all);

  if(typeMode.all){
    typeSummaryEl.textContent = "å…¨é¸ A/B/C/D";
  }else{
    const chosen = ["A","B","C","D"].filter(k=>typeMode[k]);
    typeSummaryEl.textContent = chosen.length? chosen.join(" / ") : "ï¼ˆæœªé¸ï¼‰";
  }
}
function openTypeModal(){
  refreshTypeChips();
  typeBack.style.display="flex";
}
function closeTypeModal(){ typeBack.style.display="none"; }

el("btnOpenTypeModal").onclick=openTypeModal;
el("btnCloseType").onclick=closeTypeModal;
typeBack.addEventListener("click",(e)=>{ if(e.target===typeBack) closeTypeModal(); });

chipAll.onclick = ()=>{
  typeMode = {all:true, A:true,B:true,C:true,D:true};
  refreshTypeChips();
};
function toggleOne(k){
  if(typeMode.all){
    typeMode.all=false;
    // keep all true initially then allow toggles
    typeMode.A=true; typeMode.B=true; typeMode.C=true; typeMode.D=true;
  }
  typeMode[k] = !typeMode[k];
  // at least one
  if(!typeMode.A && !typeMode.B && !typeMode.C && !typeMode.D){
    typeMode[k]=true;
  }
  refreshTypeChips();
}
chipA.onclick=()=>toggleOne("A");
chipB.onclick=()=>toggleOne("B");
chipC.onclick=()=>toggleOne("C");
chipD.onclick=()=>toggleOne("D");

el("btnSaveType").onclick=()=>{
  ALL.settings = ALL.settings || {};
  ALL.settings.typeMode = typeMode;
  saveAll(ALL);
  closeTypeModal();
  renderMap();
};

/* ==============================
   5) Badges (home)
================================ */
const BADGE_DEFS = [
  {id:"firstClear", icon:"ğŸ", color:"green", name:"é¦–æ¬¡é€šé—œ", desc:"ä»»ä¸€é—œç¬¬ä¸€æ¬¡éé—œ"},
  {id:"streak5", icon:"ğŸ”¥5", color:"gold", name:"é€£å‹ 5 é¡Œ", desc:"åŒä¸€é—œé€£çºŒç­”å° 5 é¡Œ"},
  {id:"streak10", icon:"ğŸ”¥10", color:"purple", name:"é€£å‹ 10 é¡Œ", desc:"åŒä¸€é—œé€£çºŒç­”å° 10 é¡Œ"},
  {id:"perfect10", icon:"ğŸ’¯", color:"blue", name:"å–®é—œæ»¿åˆ†", desc:"ä»»ä¸€é—œ 10/10"},
  {id:"pass10", icon:"ğŸ—ï¸", color:"gold", name:"é€šé—œ 10", desc:"ç´¯ç©éé—œ 10 é—œ"},
  {id:"pass30", icon:"ğŸ§­", color:"blue", name:"é€šé—œ 30", desc:"ç´¯ç©éé—œ 30 é—œ"},
  {id:"pass60", icon:"ğŸï¸", color:"purple", name:"é€šé—œ 60", desc:"ç´¯ç©éé—œ 60 é—œ"},
  {id:"pass100", icon:"ğŸ‘‘", color:"gold", name:"é€šé—œ 100", desc:"å…¨éƒ¨ 100 é—œå®Œæˆ"}
];

function awardBadge(id){
  if(!currentStudent) return;
  currentStudent.badges = currentStudent.badges || {};
  if(!currentStudent.badges[id]){
    currentStudent.badges[id]=true;
    saveAll(ALL);
    renderBadges();
    popToast("ğŸ… è§£é–å¾½ç« ï¼š " + (BADGE_DEFS.find(x=>x.id===id)?.name || id));
  }
}
function renderBadges(){
  badgeBox.innerHTML="";
  const owned = (currentStudent && currentStudent.badges) ? currentStudent.badges : {};
  BADGE_DEFS.forEach(b=>{
    const on = !!owned[b.id];
    const div = document.createElement("div");
    div.className="badge";
    div.innerHTML = `
      <div class="icon ${on?b.color:"gray"}">${b.icon}</div>
      <div class="t">
        <b>${b.name}${on?" âœ…":""}</b>
        <small>${b.desc}</small>
      </div>
    `;
    badgeBox.appendChild(div);
  });
}

/* ==============================
   6) Login / Reset
================================ */
function sanitizeName(v){
  return (v||"").replace(/\s+/g," ").trim();
}
function refreshHomeStats(){
  if(!currentStudent){
    curStudentEl.textContent="ï¼ˆå°šæœªç™»å…¥ï¼‰";
    curClearedEl.textContent="0";
    kLevelEl.textContent="â€”";
    kBestEl.textContent="â€”";
    renderBadges();
    return;
  }
  curStudentEl.textContent = currentStudent.name;
  const passedCount = Object.values(currentStudent.cleared||{}).filter(x=>x.passed).length;
  curClearedEl.textContent = String(passedCount);
  const next = Math.min(100, passedCount+1);
  kLevelEl.textContent = `ç¬¬ ${next} é—œ`;
  const best = currentStudent.cleared?.[String(next)]?.bestScore;
  kBestEl.textContent = (best==null) ? "â€”" : `${best}/10`;
  renderBadges();
}
function login(name){
  name = sanitizeName(name);
  if(!name){
    alert("âš ï¸ å§“åä¸å¯ç©ºç™½");
    return;
  }
  ALL = loadAll();
  currentStudent = ensureStudent(ALL, name);
  currentName = name;
  saveAll(ALL);
  refreshHomeStats();
  renderMap();
}
el("btnLogin").onclick=()=>login(el("studentName").value);
el("studentName").addEventListener("keydown",(e)=>{ if(e.key==="Enter") login(el("studentName").value); });

el("btnResetStudent").onclick=()=>{
  if(!confirm("ç¢ºå®šè¦æ¸…é™¤æœ¬æ©Ÿæ‰€æœ‰å­¸ç”Ÿè³‡æ–™ï¼Ÿï¼ˆåªæ¸…é™¤é€™å°è£ç½®ï¼‰")) return;
  localStorage.removeItem(LS_KEY);
  ALL = loadAll();
  currentStudent=null;
  currentName="";
  refreshHomeStats();
  renderMap();
  alert("å·²æ¸…é™¤ã€‚");
};

/* ==============================
   7) Map layout + curved dashed path
   - user later said "æ•´é½Šæ’å¥½" but also want curved dashed links
   => use serpentine grid with curved bezier dashed between nodes.
================================ */
const LEVELS = 100;
function levelPassed(level){
  if(!currentStudent) return false;
  return !!currentStudent.cleared?.[String(level)]?.passed;
}
function levelUnlocked(level){
  if(level===1) return true;
  return levelPassed(level-1); // must pass previous with >=8
}
function levelBest(level){
  return currentStudent?.cleared?.[String(level)]?.bestScore ?? null;
}
function buildPositions(){
  // serpentine 10 columns x 10 rows
  const cols=10, rows=10;
  const x0=60, y0=70;
  const dx=88, dy=88;
  const pos=[];
  let n=1;
  for(let r=0;r<rows;r++){
    const leftToRight = (r%2===0);
    for(let c=0;c<cols;c++){
      const cc = leftToRight ? c : (cols-1-c);
      pos[n]={x:x0+cc*dx, y:y0+r*dy};
      n++;
    }
  }
  return pos;
}
const POS = buildPositions();

function renderMap(){
  // clear nodes (keep routeSvg)
  mapInner.querySelectorAll(".levelBtn").forEach(x=>x.remove());
  routeSvg.innerHTML="";
  routeSvg.setAttribute("width","100%");
  routeSvg.setAttribute("height","100%");
  routeSvg.setAttribute("viewBox","0 0 980 980");

  // dashed routes
  function p(i){ return POS[i]; }
  const svgNS="http://www.w3.org/2000/svg";

  for(let i=1;i<LEVELS;i++){
    const a=p(i), b=p(i+1);
    const path=document.createElementNS(svgNS,"path");
    // curved bezier: control points offset based on direction
    const mx=(a.x+b.x)/2, my=(a.y+b.y)/2;
    const bend = (i%2===0) ? 26 : -26;
    const c1x = mx, c1y = a.y + bend;
    const c2x = mx, c2y = b.y - bend;
    const d = `M ${a.x} ${a.y} C ${c1x} ${c1y}, ${c2x} ${c2y}, ${b.x} ${b.y}`;
    path.setAttribute("d", d);
    path.setAttribute("fill","none");
    path.setAttribute("stroke","rgba(100,116,139,.55)");
    path.setAttribute("stroke-width","3");
    path.setAttribute("stroke-dasharray","7 10");
    path.setAttribute("stroke-linecap","round");
    routeSvg.appendChild(path);
  }

  // nodes
  for(let lvl=1; lvl<=LEVELS; lvl++){
    const btn=document.createElement("div");
    btn.className="levelBtn";
    const passed = currentStudent ? levelPassed(lvl) : false;
    const unlocked = currentStudent ? levelUnlocked(lvl) : (lvl===1);
    const best = currentStudent ? levelBest(lvl) : null;

    if(passed) btn.classList.add("cleared");
    if(!unlocked) btn.classList.add("locked");

    const star = passed ? "â­" : (unlocked ? "ğŸ¯" : "ğŸ”’");
    const mini = passed ? `${best ?? 0}/10` : (unlocked ? "å¯æŒ‘æˆ°" : "æœªè§£é–");

    btn.innerHTML = `<div class="star">${star}</div><div class="n">ç¬¬${lvl}é—œ</div><div class="mini">${mini}</div>`;
    btn.style.left = (POS[lvl].x-42)+"px";
    btn.style.top  = (POS[lvl].y-42)+"px";

    btn.onclick=()=>{
      if(!currentStudent){ alert("è«‹å…ˆè¼¸å…¥å§“åç™»å…¥ã€‚"); return; }
      if(!levelUnlocked(lvl)){ alert("âš ï¸ éœ€è¦å…ˆé€šéä¸Šä¸€é—œï¼ˆâ‰¥8/10ï¼‰æ‰èƒ½é»é€™ä¸€é—œã€‚"); return; }
      startLevel(lvl);
    };
    mapInner.appendChild(btn);
  }

  // update summary
  refreshHomeStats();
  refreshTypeChips();
}

/* ==============================
   8) Start Next / Go Map
================================ */
el("btnGoMap").onclick=()=>{ el("mapCanvas").scrollIntoView({behavior:"smooth"}); };

el("btnStartNext").onclick=()=>{
  if(!currentStudent){ alert("è«‹å…ˆè¼¸å…¥å§“åç™»å…¥ã€‚"); return; }
  const passedCount = Object.values(currentStudent.cleared||{}).filter(x=>x.passed).length;
  const next = Math.min(100, passedCount+1);
  startLevel(next);
};

/* ==============================
   9) Game engine
================================ */
let game = null;
// per level: 10 questions
const Q_PER_LEVEL = 10;
const PASS_SCORE = 8;

function shuffle(arr){
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function pickWords(n){
  // pick from full 153 randomly but stable per level attempt: use seeded-ish
  return shuffle(WORDS).slice(0,n);
}
function getSelectedTypes(){
  if(typeMode.all) return ["A","B","C","D"];
  const t = ["A","B","C","D"].filter(k=>typeMode[k]);
  return t.length ? t : ["A"];
}
function buildTypePlan(){
  const chosen = getSelectedTypes();
  if(typeMode.all){
    // average distribution within 10: 3+3+2+2 randomized (or 3/3/2/2)
    const base=["A","A","A","B","B","B","C","C","D","D"];
    return shuffle(base);
  }else{
    // fill 10 from chosen random
    const plan=[];
    while(plan.length<Q_PER_LEVEL){
      plan.push(chosen[Math.floor(Math.random()*chosen.length)]);
    }
    return plan;
  }
}

let tick=null, t0=0;

function fmt(ms){
  const s=Math.floor(ms/1000);
  const mm=String(Math.floor(s/60)).padStart(2,"0");
  const ss=String(s%60).padStart(2,"0");
  return mm+":"+ss;
}

function openGame(){
  gameBack.style.display="flex";
}
function closeGame(){
  gameBack.style.display="none";
  stopTimer();
}
el("btnCloseGame").onclick=closeGame;
gameBack.addEventListener("click",(e)=>{ if(e.target===gameBack) closeGame(); });

el("btnBackToMap").onclick=()=>{
  closeGame();
  // keep on map
};

function startTimer(){
  stopTimer();
  t0=Date.now();
  tick=setInterval(()=>{ timeEl.textContent = fmt(Date.now()-t0); }, 200);
}
function stopTimer(){
  if(tick){ clearInterval(tick); tick=null; }
}

function setFeedback(kind, html){
  feedback.innerHTML = `<div class="msg ${kind}">${html}</div>`;
}
function clearFeedback(){ feedback.innerHTML=""; }

function updateTop(){
  gameTitle.textContent = `ç¬¬ ${game.level} é—œ`;
  qIdxEl.textContent = String(game.qIndex+1);
  scoreEl.textContent = String(game.score);
  barEl.style.width = `${((game.qIndex)/Q_PER_LEVEL)*100}%`;
}

function updateRateUI(){
  rateSlider.value = String(speechRate);
  rateVal.textContent = Number(speechRate).toFixed(2);
}
rateSlider.oninput=()=>{
  speechRate = Number(rateSlider.value);
  rateVal.textContent = Number(speechRate).toFixed(2);
  ALL.settings = ALL.settings || {};
  ALL.settings.speechRate = speechRate;
  saveAll(ALL);
};

function speakWord(word){
  // Only speak the word (no question number)
  try{
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(word);
    u.lang="en-US";
    u.rate = speechRate;

    // choose clearest English voice if possible
    const voices = window.speechSynthesis.getVoices();
    const prefer = voices.filter(v=>{
      const n=(v.name||"").toLowerCase();
      const l=(v.lang||"").toLowerCase();
      return l.startsWith("en") && (n.includes("google") || n.includes("siri") || n.includes("microsoft") || n.includes("natural"));
    });
    const anyEn = voices.filter(v=>(v.lang||"").toLowerCase().startsWith("en"));
    const v = prefer[0] || anyEn[0] || voices[0];
    if(v) u.voice=v;

    window.speechSynthesis.speak(u);
  }catch(e){
    alert("ä½ çš„è£ç½®ä¸æ”¯æ´èªéŸ³æ’­æ”¾ï¼ˆSpeechSynthesisï¼‰ã€‚");
  }
}

el("btnPlay").onclick=()=>{
  if(!game) return;
  const q = game.questions[game.qIndex];
  if(q.type==="A" || q.type==="D"){
    speakWord(q.word.en);
  }else if(q.type==="B"){
    // optional: allow pronounce too
    speakWord(q.word.en);
  }else{
    // C: allow pronounce the currently selected? but keep simple: pronounce first en
    speakWord(q.pairs[0].en);
  }
};
el("btnReplay").onclick=()=>el("btnPlay").click();

function buildChoices(correctZh){
  // return 4 chinese options includes correct + 3 random
  const pool = WORDS.filter(w=>w.zh!==correctZh);
  const picks = shuffle(pool).slice(0,3).map(w=>w.zh);
  const opts = shuffle([correctZh, ...picks]);
  return opts;
}

function startLevel(level){
  if(!currentStudent){ alert("è«‹å…ˆç™»å…¥ã€‚"); return; }

  // enforce locked on click
  if(!levelUnlocked(level)){
    alert("âš ï¸ éœ€è¦å…ˆé€šéä¸Šä¸€é—œï¼ˆâ‰¥8/10ï¼‰æ‰èƒ½é€²å…¥ã€‚");
    return;
  }

  const plan = buildTypePlan();
  const wordPicks = pickWords(30); // more variety for 10 questions

  const questions = [];
  let wp=0;

  for(let i=0;i<Q_PER_LEVEL;i++){
    const type = plan[i];
    if(type==="C"){
      // 4 pairs question
      const pairs = shuffle(wordPicks).slice(wp, wp+4);
      wp += 4;
      questions.push({type, pairs, // array of 4 WORD objects
        // for scoring: mistakeFlag
        mistake:false,
        donePairs:0,
        selected:null
      });
    }else{
      const word = wordPicks[wp % wordPicks.length];
      wp++;
      questions.push({type, word, choices: buildChoices(word.zh), answered:false, correct:null});
    }
  }

  game = {
    level,
    qIndex:0,
    score:0,
    streak:0,
    streakBest:0,
    startedAt: Date.now(),
    questions,
    // record answers to support "ä¸Šä¸€é¡Œ"
    history: Array(Q_PER_LEVEL).fill(null) // {scoredDelta, streakBefore, streakAfter}
  };

  openGame();
  updateRateUI();
  startTimer();
  renderQuestion();
}

function renderQuestion(){
  clearFeedback();
  updateTop();
  const q = game.questions[game.qIndex];

  // mode tag + title/sub
  modeTagEl.textContent = q.type;
  const modeTitle = {
    A:"A è½åŠ›é¸å­—ï¼ˆè½â†’é¸ä¸­æ–‡ï½œä¸é¡¯ç¤ºè‹±æ–‡ï¼‰",
    B:"B çœ‹è‹±é¸å­—ï¼ˆçœ‹è‹±æ–‡â†’é¸ä¸­æ–‡ï¼‰",
    C:"C ä¸­è‹±é…å°ï¼ˆ4 çµ„ï¼‰",
    D:"D è½åŠ›æ‹¼éŸ³ï¼ˆè½â†’æ‹¼è‹±æ–‡ï½œä¸é¡¯ç¤ºè‹±æ–‡ï¼‰"
  }[q.type];
  qTitleEl.textContent = modeTitle;
  qSubEl.textContent = `ç¬¬ ${game.qIndex+1} / 10 é¡Œï½œæœ¬é—œç›®æ¨™ï¼šâ‰¥8 åˆ†æ‰èƒ½è§£é–ä¸‹ä¸€é—œ`;

  // show/hide listen buttons: always show but useful in A/D
  questionArea.innerHTML = "";

  if(q.type==="A"){
    // Listen -> choose Chinese (NO English displayed)
    const box = document.createElement("div");
    box.className="center";
    box.innerHTML = `
      <div class="hintBox">è¦å‰‡ï¼šæŒ‰ã€Œæ’­æ”¾ã€è½è‹±æ–‡å¾Œï¼Œé¸å‡ºæ­£ç¢ºä¸­æ–‡æ„æ€ï¼ˆä¸æœƒé¡¯ç¤ºè‹±æ–‡å–®å­—ï¼‰ã€‚</div>
      <div class="choices" id="choices"></div>
    `;
    questionArea.appendChild(box);
    const c = box.querySelector("#choices");
    q.choices.forEach(opt=>{
      const b=document.createElement("div");
      b.className="choice";
      b.textContent=opt;
      b.onclick=()=>answerChoice(opt);
      c.appendChild(b);
    });
  }

  if(q.type==="B"){
    const box = document.createElement("div");
    box.className="center";
    box.innerHTML = `
      <div class="wordBig">${q.word.en}</div>
      <div class="hintBox">è¦å‰‡ï¼šçœ‹è‹±æ–‡å–®å­—ï¼Œé¸å‡ºæ­£ç¢ºä¸­æ–‡æ„æ€ã€‚</div>
      <div class="choices" id="choices"></div>
    `;
    questionArea.appendChild(box);
    const c = box.querySelector("#choices");
    q.choices.forEach(opt=>{
      const b=document.createElement("div");
      b.className="choice";
      b.textContent=opt;
      b.onclick=()=>answerChoice(opt);
      c.appendChild(b);
    });
  }

  if(q.type==="D"){
    const box = document.createElement("div");
    box.className="center";
    box.innerHTML = `
      <div class="hintBox">è¦å‰‡ï¼šæŒ‰ã€Œæ’­æ”¾ã€è½è‹±æ–‡å–®å­—ï¼Œè¼¸å…¥ä½ è½åˆ°çš„æ‹¼å­—ï¼ˆä¸é¡¯ç¤ºè‹±æ–‡ï¼‰ã€‚</div>
      <div class="typeWrap">
        <input class="typeInput" id="typeAns" placeholder="è«‹è¼¸å…¥è‹±æ–‡æ‹¼å­—" autocomplete="off" autocapitalize="none" />
      </div>
      <div class="row" style="justify-content:center; margin-top:12px">
        <button class="btn primary" id="btnCheck">âœ… é€å‡º</button>
      </div>
    `;
    questionArea.appendChild(box);
    const inp = box.querySelector("#typeAns");
    inp.focus();
    box.querySelector("#btnCheck").onclick=()=>answerTyping(inp.value);
    inp.addEventListener("keydown",(e)=>{ if(e.key==="Enter") box.querySelector("#btnCheck").click(); });
  }

  if(q.type==="C"){
    // matching: 4 pairs, show as cards
    const box = document.createElement("div");
    box.className="center";
    box.innerHTML = `
      <div class="hintBox">è¦å‰‡ï¼šå…ˆé»ã€Œè‹±æ–‡ã€å†é»ã€Œä¸­æ–‡ã€ã€‚é»éŒ¯æœƒå‘Šè¨´ä½ æ­£ç¢ºç­”æ¡ˆï¼Œä½†ä»å¯ç¹¼çºŒå®Œæˆé…å°ã€‚<br/>ï¼ˆæœ¬é¡Œ 4 çµ„å…¨é…å°å®Œæˆæ‰ç®—å®Œæˆ 1 é¡Œï¼›è‹¥æœ¬é¡Œä¸­æ›¾ç­”éŒ¯ï¼Œé€™é¡Œè¨˜ 0 åˆ†ï¼‰</div>
      <div class="match-grid" id="mg">
        <div class="match-col" id="ml"></div>
        <div class="match-col" id="mr"></div>
      </div>
    `;
    questionArea.appendChild(box);

    const left = shuffle(q.pairs);
    const right = shuffle(q.pairs);

    const ml = box.querySelector("#ml");
    const mr = box.querySelector("#mr");

    q.selected = null;

    left.forEach(w=>{
      const d=document.createElement("div");
      d.className="mcard";
      d.textContent=w.en;
      d.dataset.en=w.en;
      d.onclick=()=>{
        if(d.classList.contains("done")) return;
        q.selected = w;
        box.querySelectorAll(".mcard").forEach(x=>x.classList.remove("active"));
        d.classList.add("active");
      };
      ml.appendChild(d);
    });

    right.forEach(w=>{
      const d=document.createElement("div");
      d.className="mcard";
      d.textContent=w.zh;
      d.dataset.zh=w.zh;
      d.dataset.en=w.en;
      d.onclick=()=>{
        if(d.classList.contains("done")) return;
        if(!q.selected) return;

        if(q.selected.en === w.en){
          // mark both done
          d.classList.add("done");
          [...ml.children].forEach(c=>{
            if(c.dataset.en === q.selected.en){
              c.classList.add("done");
              c.classList.remove("active");
            }
          });
          q.selected = null;
          q.donePairs = (q.donePairs||0)+1;

          if(q.donePairs>=4){
            // finished this question: score if no mistakes
            const gained = q.mistake ? 0 : 1;
            applyScore(gained, gained? "âœ… é…å°å®Œæˆï¼æœ¬é¡Œ +1 åˆ†" : "âš ï¸ é…å°å®Œæˆï¼Œä½†æœ¬é¡Œæ›¾ç­”éŒ¯ï¼Œæ•…æœ¬é¡Œ 0 åˆ†");
            lockAndAutoNext();
          }
        }else{
          q.mistake = true;
          const correctZh = q.selected.zh;
          setFeedback("bad", `âŒ éŒ¯äº†ï¼æ­£ç¢ºç­”æ¡ˆï¼š<b>${q.selected.en}</b> = <b>${correctZh}</b>`);
          // clear selection
          q.selected = null;
          box.querySelectorAll(".mcard").forEach(x=>x.classList.remove("active"));
        }
      };
      mr.appendChild(d);
    });
  }

  // buttons state
  el("btnPrev").disabled = (game.qIndex===0);
}

function answerChoice(pickedZh){
  const q = game.questions[game.qIndex];
  if(q.type!=="A" && q.type!=="B") return;
  if(q.answered) return;

  const correct = q.word.zh;
  const ok = pickedZh === correct;

  // paint choices
  const nodes = questionArea.querySelectorAll(".choice");
  nodes.forEach(n=>{
    if(n.textContent===correct) n.classList.add("good");
    if(n.textContent===pickedZh && !ok) n.classList.add("bad");
    n.style.pointerEvents="none";
  });

  q.answered=true;
  q.correct=ok;

  if(ok){
    applyScore(1, "âœ… ç­”å°ï¼+1 åˆ†");
  }else{
    applyScore(0, `âŒ éŒ¯äº†ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š<b>${correct}</b>`);
  }

  lockAndAutoNext();
}

function answerTyping(value){
  const q = game.questions[game.qIndex];
  if(q.type!=="D") return;

  const ans = (value||"").trim().toLowerCase();
  const correct = q.word.en.trim().toLowerCase();
  const ok = ans === correct;

  // lock input
  const inp = questionArea.querySelector(".typeInput");
  if(inp) inp.disabled=true;

  if(ok){
    applyScore(1, "âœ… ç­”å°ï¼+1 åˆ†");
  }else{
    applyScore(0, `âŒ éŒ¯äº†ï¼æ­£ç¢ºæ‹¼å­—æ˜¯ï¼š<b>${q.word.en}</b>ï¼ˆä¸­æ–‡ï¼š${q.word.zh}ï¼‰`);
  }

  lockAndAutoNext();
}

function applyScore(gain, msg){
  // update streak
  const before = game.streak;
  if(gain===1){
    game.score += 1;
    game.streak += 1;
    game.streakBest = Math.max(game.streakBest, game.streak);
    setFeedback("good", msg);

    if(game.streak===5) { awardBadge("streak5"); popToast("ğŸ”¥ é€£çºŒç­”å° 5 é¡Œï¼"); }
    if(game.streak===10){ awardBadge("streak10"); popToast("ğŸ”¥ é€£çºŒç­”å° 10 é¡Œï¼"); }
  }else{
    game.streak = 0;
    setFeedback("bad", msg);
  }
  // record history for prev
  game.history[game.qIndex] = {
    gain,
    streakBefore: before
  };

  updateTop();
}

function lockAndAutoNext(){
  // enable next; but if last question show finish summary
  // user wants "å›é—œå¡" button always visible; already there.
}

function nextQuestion(){
  if(!game) return;

  // if question not answered in A/B/D, prevent skipping
  const q = game.questions[game.qIndex];
  if(q.type==="A" || q.type==="B"){
    if(!q.answered){
      alert("è«‹å…ˆä½œç­”ï¼ˆé¸ä¸€å€‹ä¸­æ–‡ï¼‰ã€‚");
      return;
    }
  }
  if(q.type==="D"){
    // allow next only after input disabled
    const inp = questionArea.querySelector(".typeInput");
    if(inp && !inp.disabled){
      alert("è«‹å…ˆè¼¸å…¥ä¸¦é€å‡ºç­”æ¡ˆã€‚");
      return;
    }
  }
  if(q.type==="C"){
    if((q.donePairs||0) < 4){
      alert("è«‹å…ˆå®Œæˆ 4 çµ„é…å°ã€‚");
      return;
    }
  }

  if(game.qIndex < Q_PER_LEVEL-1){
    game.qIndex += 1;
    barEl.style.width = `${((game.qIndex)/Q_PER_LEVEL)*100}%`;
    renderQuestion();
  }else{
    finishLevel();
  }
}

function prevQuestion(){
  if(!game) return;
  if(game.qIndex===0) return;

  // rollback scoring for current question if it had been scored
  const cur = game.history[game.qIndex];
  if(cur){
    // remove gain if it was 1
    if(cur.gain===1){
      game.score -= 1;
    }
    // restore streak to what it was before that question
    game.streak = cur.streakBefore;
    game.history[game.qIndex] = null;
  }

  // move back
  game.qIndex -= 1;

  // also rollback previous question scoring to allow re-answer:
  const prev = game.history[game.qIndex];
  if(prev){
    if(prev.gain===1){
      game.score -= 1;
    }
    game.streak = prev.streakBefore;
    game.history[game.qIndex] = null;
  }

  renderQuestion();
  setFeedback("bad", "â†©ï¸ å·²å›åˆ°ä¸Šä¸€é¡Œï¼Œè«‹é‡æ–°ä½œç­”ã€‚");
  updateTop();
}

el("btnNext").onclick=nextQuestion;
el("btnPrev").onclick=prevQuestion;

function finishLevel(){
  stopTimer();
  const spent = Date.now() - game.startedAt;
  const s = game.score;
  const passed = s >= PASS_SCORE;

  // update student record
  const lvl = String(game.level);
  currentStudent.cleared = currentStudent.cleared || {};
  const old = currentStudent.cleared[lvl] || {bestScore:0, passed:false, attempts:0, firstClearTs:null};

  old.attempts = (old.attempts||0) + 1;
  old.bestScore = Math.max(old.bestScore||0, s);

  const wasPassed = !!old.passed;
  if(passed) old.passed = true;

  // first clear confetti only once per level
  const firstTimeClear = passed && !old.firstClearTs;
  if(firstTimeClear){
    old.firstClearTs = Date.now();
    awardBadge("firstClear");
  }

  currentStudent.cleared[lvl] = old;

  // compute totals
  const passedCount = Object.values(currentStudent.cleared).filter(x=>x.passed).length;
  currentStudent.totalPassed = passedCount;
  currentStudent.lastPlayed = Date.now();

  // milestone badges
  if(s===10) awardBadge("perfect10");
  if(passedCount>=10) awardBadge("pass10");
  if(passedCount>=30) awardBadge("pass30");
  if(passedCount>=60) awardBadge("pass60");
  if(passedCount>=100) awardBadge("pass100");

  saveAll(ALL);

  // summary UI
  const msg = passed
    ? `ğŸ‰ ç¬¬ ${game.level} é—œé€šéï¼å¾—åˆ†ï¼š<b>${s}/10</b>ï¼ˆâ‰¥8 æœƒè§£é–ä¸‹ä¸€é—œï¼‰<br/><span class="small">æ™‚é–“ï¼š${fmt(spent)}</span>`
    : `âŒ ç¬¬ ${game.level} é—œæœªé€šéã€‚å¾—åˆ†ï¼š<b>${s}/10</b>ï¼ˆéœ€è¦ â‰¥8 æ‰èƒ½è§£é–ä¸‹ä¸€é—œï¼‰<br/><span class="small">å¯ä»¥é‡ç©é€™ä¸€é—œå†æŒ‘æˆ°ã€‚</span>`;

  questionArea.innerHTML = `
    <div class="center">
      <div class="qTitle">${passed ? "ğŸ¯ é€šé—œçµæœ" : "â›³ å†è©¦ä¸€æ¬¡"}</div>
      <div class="msg ${passed?"good":"bad"}" style="display:inline-block; max-width:860px">${msg}</div>
      <div style="margin-top:14px" class="row" >
        <button class="btn ghost" id="btnReplayLevel">ğŸ” é‡ç©æœ¬é—œ</button>
        <button class="btn primary" id="btnGoMap2">ğŸ—ºï¸ å›é—œå¡åœ°åœ–</button>
        <button class="btn ${passed?"primary":"ghost"}" id="btnNextLevel">${passed?"â¡ï¸ å‰å¾€ä¸‹ä¸€é—œ":"ğŸ”’ ä¸‹ä¸€é—œï¼ˆæœªè§£é–ï¼‰"}</button>
      </div>
      <div class="help" style="max-width:860px; margin:12px auto 0">
        âœ… ä¸‹ä¸€é—œæ˜¯å¦å¯é»ï¼šå–æ±ºæ–¼æœ¬é—œæ˜¯å¦é”åˆ° 8 åˆ†ï¼ˆå«ï¼‰ã€‚<br/>
        ğŸ” é‡ç©ï¼šä¸æœƒå–æ¶ˆå·²è§£é–é—œå¡ï¼›ä½†æœ¬é—œæœ€é«˜åˆ†æœƒæ›´æ–°ã€‚
      </div>
    </div>
  `;

  // confetti only on first-time clear
  if(firstTimeClear){
    fireConfetti();
  }

  // update top bar / map
  refreshHomeStats();
  renderMap();

  // wire buttons
  document.getElementById("btnGoMap2").onclick=()=>{ closeGame(); };
  document.getElementById("btnReplayLevel").onclick=()=>{ startLevel(game.level); };

  const next = Math.min(100, game.level+1);
  const btnNextLevel = document.getElementById("btnNextLevel");
  if(passed && next<=100){
    btnNextLevel.onclick=()=>{
      if(!levelUnlocked(next)){ alert("ä¸‹ä¸€é—œå°šæœªè§£é–ã€‚"); return; }
      startLevel(next);
    };
  }else{
    btnNextLevel.onclick=()=>alert("ä¸‹ä¸€é—œå°šæœªè§£é–ï¼ˆæœ¬é—œéœ€ â‰¥8 åˆ†ï¼‰ã€‚");
  }

  // freeze nav buttons
  el("btnPrev").disabled=true;
  el("btnNext").disabled=true;
}

function popToast(text){
  const p = el("pop");
  p.textContent = text;
  p.style.display="block";
  p.style.opacity="1";
  p.style.transform="translateX(-50%) translateY(0)";
  setTimeout(()=>{
    p.style.opacity="0";
    p.style.transform="translateX(-50%) translateY(-6px)";
  }, 1200);
  setTimeout(()=>{ p.style.display="none"; }, 1600);
}

function fireConfetti(){
  const box = el("confetti");
  box.innerHTML="";
  box.style.display="block";

  const colors = ["#22c55e","#2563eb","#f59e0b","#a855f7","#ef4444","#06b6d4"];
  const W = window.innerWidth;
  const N = 120;

  for(let i=0;i<N;i++){
    const d=document.createElement("div");
    d.className="confettiPiece";
    d.style.left = Math.random()*W + "px";
    d.style.top = (-20 - Math.random()*200) + "px";
    d.style.background = colors[Math.floor(Math.random()*colors.length)];
    d.style.width = (8 + Math.random()*10) + "px";
    d.style.height = (10 + Math.random()*18) + "px";
    d.style.animationDuration = (900 + Math.random()*700) + "ms";
    d.style.opacity = (0.7 + Math.random()*0.3);
    box.appendChild(d);
  }

  setTimeout(()=>{ box.style.display="none"; box.innerHTML=""; }, 1500);
}

/* ==============================
   10) Initial render
================================ */
(function init(){
  // persist rate
  updateRateUI();

  // preload voices for better first speak
  if("speechSynthesis" in window){
    window.speechSynthesis.onvoiceschanged = ()=>{};
  }

  // render empty badges initially
  renderBadges();

  // map
  renderMap();

  // default: try auto-login last student if exists
  const all = loadAll();
  const names = all.students ? Object.keys(all.students) : [];
  if(names.length){
    // pick the most recently played
    let best = names[0], bestTs=0;
    names.forEach(n=>{
      const s = all.students[n];
      const ts = s.lastPlayed || 0;
      if(ts>bestTs){ bestTs=ts; best=n; }
    });
    login(best);
  }
})();
</script>
</body>
</html>
